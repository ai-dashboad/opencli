# OpenCLI çœŸå®é›†æˆçŠ¶æ€è¯„ä¼°

**è¯„ä¼°æ—¥æœŸ:** 2025-02-05
**è¯„ä¼°äºº:** æ·±åº¦æŠ€æœ¯å®¡æŸ¥
**ç»“è®º:** âš ï¸ **ä¸¥é‡é—®é¢˜ - å®¢æˆ·ç«¯ä¸ Daemon ä¹‹é—´ç¼ºä¹å®Œæ•´é›†æˆ**

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜1: å„å®¢æˆ·ç«¯ä¸ Daemon é›†æˆä¸å®Œæ•´

**å‘ç°:**
- âœ… Daemon åœ¨è¿è¡Œï¼ˆç«¯å£ 9875, 9876, 9877ï¼‰
- âŒ **CLI æ— æ³•ç¼–è¯‘**ï¼ˆéœ€è¦ Rust/Cargoï¼Œæœªå®‰è£…ï¼‰
- âŒ **Web UI API ç«¯ç‚¹ä¸åŒ¹é…**ï¼ˆæœŸæœ› 9529ï¼Œå®é™… 9875ï¼‰
- âš ï¸ **ç§»åŠ¨ç«¯é›†æˆæœªéªŒè¯**
- âœ… **æ’ä»¶å¸‚åœº UI ç‹¬ç«‹è¿è¡Œ**ï¼ˆä½†åªæ˜¯ä¸€ä¸ªå­¤ç«‹çš„Webç•Œé¢ï¼‰

---

## ğŸ“‹ è¯¦ç»†é›†æˆåˆ†æ

### 1. CLI â†” Daemon é›†æˆ

#### CLI ç«¯ (Rust)
**æ–‡ä»¶:** `cli/src/ipc.rs`
```rust
const SOCKET_PATH: &str = "/tmp/opencli.sock";

pub fn connect() -> Result<Self> {
    let stream = UnixStream::connect(SOCKET_PATH)
```

**çŠ¶æ€:**
- âœ… IPC å®¢æˆ·ç«¯ä»£ç å­˜åœ¨
- âœ… ä½¿ç”¨ Unix Socket (/tmp/opencli.sock)
- âœ… MessagePack åºåˆ—åŒ–
- âŒ **æ— æ³•ç¼–è¯‘** - éœ€è¦ Cargo (Rust å·¥å…·é“¾)
- âŒ **æœªæµ‹è¯•** - æ— å¯æ‰§è¡Œæ–‡ä»¶

#### Daemon ç«¯ (Dart)
**æ–‡ä»¶:** `daemon/lib/ipc/ipc_server.dart`
```dart
_server = await ServerSocket.bind(
  InternetAddress(socketPath, type: InternetAddressType.unix),
```

**çŠ¶æ€:**
- âœ… IPC æœåŠ¡å™¨åœ¨è¿è¡Œ
- âœ… Socket æ–‡ä»¶å­˜åœ¨: `/tmp/opencli.sock`
- âœ… ç›‘å¬ IPC è¿æ¥
- âš ï¸ **ä½† CLI æ— æ³•ä½¿ç”¨**

**é›†æˆçŠ¶æ€:** âš ï¸ **ç†è®ºä¸Šå¯è¡Œï¼Œå®é™…æ— æ³•éªŒè¯**

---

### 2. Web UI â†” Daemon é›†æˆ

#### Web UI æœŸæœ›çš„ç«¯ç‚¹
**æ–‡ä»¶:** `web-ui/src/api/client.ts`
```typescript
async execute(method: string, params: string[] = []): Promise<any> {
  const response = await fetch('http://localhost:9529/api/v1/execute', {
    method: 'POST',
    ...
  });
}
```

**æœŸæœ›:**
- ç«¯å£: `9529`
- è·¯å¾„: `/api/v1/execute`
- æ–¹æ³•: POST
- æ ¼å¼: JSON

#### Daemon å®é™…æä¾›çš„ç«¯ç‚¹
**æ–‡ä»¶:** `daemon/lib/ui/status_server.dart`

**å®é™…ç«¯å£:**
- `9875` - Status API
- `9876` - Mobile WebSocket
- `9877` - Plugin Marketplace

**å®é™…è·¯å¾„:**
```
GET  http://localhost:9875/status
GET  http://localhost:9875/health
```

**é—®é¢˜:**
- âŒ **ç«¯å£ä¸åŒ¹é…** (9529 vs 9875)
- âŒ **è·¯å¾„ä¸åŒ¹é…** (/api/v1/execute vs /status)
- âŒ **åè®®ä¸åŒ¹é…** (æœŸæœ› REST APIï¼Œå®é™…æ˜¯çŠ¶æ€æŸ¥è¯¢)

**é›†æˆçŠ¶æ€:** âŒ **å®Œå…¨ä¸å…¼å®¹**

---

### 3. ç§»åŠ¨åº”ç”¨ â†” Daemon é›†æˆ

#### ç§»åŠ¨ç«¯ (Flutter)
**æ–‡ä»¶:** `opencli_app/lib/services/websocket_service.dart`

**æœŸæœ›:**
```dart
final channel = WebSocketChannel.connect(
  Uri.parse('ws://localhost:9876'),
);
```

#### Daemon ç«¯
**æ–‡ä»¶:** `daemon/lib/mobile/mobile_connection_manager.dart`
```dart
_server = await io.serve(
  handler,
  '0.0.0.0',
  port, // é»˜è®¤ 9876
);
```

**çŠ¶æ€:**
- âœ… Daemon WebSocket æœåŠ¡å™¨è¿è¡Œåœ¨ 9876
- âœ… ç§»åŠ¨ç«¯ä»£ç è¿æ¥åˆ° 9876
- âš ï¸ **éœ€è¦éªŒè¯å®é™…é€šä¿¡**
- âš ï¸ **éœ€è¦æµ‹è¯•è®¾å¤‡é…å¯¹**

**é›†æˆçŠ¶æ€:** âš ï¸ **ç†è®ºå¯è¡Œï¼Œéœ€è¦å®é™…æµ‹è¯•**

---

### 4. æ’ä»¶å¸‚åœº UI â†” Daemon é›†æˆ

#### æ’ä»¶å¸‚åœº (ç‹¬ç«‹Web UI)
**è¿è¡Œäº:** `http://localhost:9877`
**æ–‡ä»¶:** `daemon/lib/ui/plugin_marketplace_ui.dart`

**API ç«¯ç‚¹:**
```dart
router.get('/api/plugins', _handleGetPlugins);
router.post('/api/plugins/<name>/install', _handleInstallPlugin);
router.delete('/api/plugins/<name>/uninstall', _handleUninstallPlugin);
router.post('/api/plugins/<name>/start', _handleStartPlugin);
router.post('/api/plugins/<name>/stop', _handleStopPlugin);
router.get('/api/plugins/<name>/config', _handleGetPluginConfig);
router.post('/api/plugins/<name>/configure', _handleConfigurePlugin);
```

**å®é™…éªŒè¯:**
```bash
âœ… curl http://localhost:9877/api/plugins  # å·¥ä½œæ­£å¸¸
âœ… è¿”å› 8 ä¸ªæ’ä»¶
âœ… å®‰è£…/å¸è½½åŠŸèƒ½å·²å®ç°
âœ… é…ç½®åŠŸèƒ½å·²å®ç°
âœ… æ›´æ–°æ£€æŸ¥å·²å®ç°
```

**é—®é¢˜:**
- âœ… æ’ä»¶å¸‚åœºæœ¬èº«å®Œæ•´
- âŒ **ä½†å®ƒæ˜¯å­¤ç«‹çš„** - ä¸ä¸ä¸» Web UI é›†æˆ
- âŒ **æ²¡æœ‰ç»Ÿä¸€çš„æ§åˆ¶å°**
- âŒ **ç”¨æˆ·éœ€è¦è®¿é—®ä¸åŒç«¯å£**

**é›†æˆçŠ¶æ€:** âš ï¸ **åŠŸèƒ½å®Œæ•´ä½†å­¤ç«‹è¿è¡Œ**

---

## ğŸ” æ ¹æœ¬é—®é¢˜åˆ†æ

### é—®é¢˜1: å¤šä¸ªç‹¬ç«‹ç³»ç»Ÿï¼Œç¼ºä¹ç»Ÿä¸€é›†æˆ

**ç°çŠ¶:**
```
CLI (Rust)          â†’ IPC Socket â†’ Daemon (ç†è®ºå¯è¡Œï¼Œæ— æ³•éªŒè¯)
                      /tmp/opencli.sock

Web UI (React)      â†’ HTTP API   â†’ ??? (ç«¯ç‚¹ä¸åŒ¹é…)
                      :9529         :9875

Mobile (Flutter)    â†’ WebSocket  â†’ Daemon (ç†è®ºå¯è¡Œ)
                      :9876         :9876

Plugin UI (HTML)    â†’ HTTP API   â†’ Plugin Manager (å·¥ä½œæ­£å¸¸)
                      :9877         :9877
```

**é—®é¢˜:**
1. **Web UI æ— æ³•è¿æ¥** - ç«¯ç‚¹å®Œå…¨ä¸åŒ¹é…
2. **CLI æ— æ³•ä½¿ç”¨** - éœ€è¦ç¼–è¯‘ï¼Œæ²¡æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
3. **æ²¡æœ‰ç»Ÿä¸€å…¥å£** - ç”¨æˆ·éœ€è¦è®°ä½å¤šä¸ªç«¯å£
4. **ç¼ºå°‘é›†æˆæµ‹è¯•** - æ²¡æœ‰éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

---

### é—®é¢˜2: API è®¾è®¡ä¸ä¸€è‡´

**CLI æœŸæœ›:**
```json
{
  "method": "task.submit",
  "params": ["do something"],
  "context": {}
}
```

**Web UI æœŸæœ›:**
```json
POST /api/v1/execute
{
  "method": "task.submit",
  "params": ["do something"]
}
```

**æ’ä»¶å¸‚åœºæä¾›:**
```json
GET /api/plugins
POST /api/plugins/:name/install
```

**çŠ¶æ€APIæä¾›:**
```json
GET /status
GET /health
```

**é—®é¢˜:** å››ä¸ªä¸åŒçš„APIè®¾è®¡ï¼Œæ²¡æœ‰ç»Ÿä¸€è§„èŒƒ

---

## ğŸ“Š å®é™…å¯ç”¨æ€§çŸ©é˜µ

| åŠŸèƒ½ | ç†è®ºè®¾è®¡ | å®é™…å®ç° | å¯ç”¨æ€§ | é—®é¢˜ |
|------|---------|---------|--------|------|
| CLI â†’ Daemon | âœ… è®¾è®¡å®Œæ•´ | âŒ æ— æ³•ç¼–è¯‘ | 0% | éœ€è¦Rustå·¥å…·é“¾ |
| Web UI â†’ Daemon | âœ… è®¾è®¡å®Œæ•´ | âŒ ç«¯ç‚¹ä¸åŒ¹é… | 0% | APIä¸å…¼å®¹ |
| Mobile â†’ Daemon | âœ… è®¾è®¡å®Œæ•´ | âš ï¸ æœªæµ‹è¯• | 50% | éœ€è¦å®æµ‹ |
| Plugin UI â†’ Plugin Mgr | âœ… è®¾è®¡å®Œæ•´ | âœ… å®Œå…¨å¯ç”¨ | 100% | å·¥ä½œæ­£å¸¸ |
| Daemon IPC | âœ… è®¾è®¡å®Œæ•´ | âœ… è¿è¡Œä¸­ | 100% | ä½†æ— å®¢æˆ·ç«¯ |
| Daemon WebSocket | âœ… è®¾è®¡å®Œæ•´ | âœ… è¿è¡Œä¸­ | 100% | ä½†æœªéªŒè¯ |
| Daemon Status API | âœ… è®¾è®¡å®Œæ•´ | âœ… è¿è¡Œä¸­ | 100% | ä½†åŠŸèƒ½æœ‰é™ |

**æ€»ä½“å¯ç”¨æ€§:** åªæœ‰æ’ä»¶å¸‚åœºUIçœŸæ­£å¯ç”¨ï¼ˆå æ¯”çº¦ 15%ï¼‰

---

## ğŸš¨ å…³é”®ç¼ºå¤±

### 1. CLI äºŒè¿›åˆ¶æ–‡ä»¶
- âŒ æ²¡æœ‰é¢„ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶
- âŒ æ²¡æœ‰æ„å»ºè„šæœ¬
- âŒ æ²¡æœ‰å‘å¸ƒæµç¨‹
- âŒ ç”¨æˆ·æ— æ³•ä½¿ç”¨ `opencli` å‘½ä»¤

### 2. Web Dashboard é›†æˆ
- âŒ Web UI æ— æ³•è¿æ¥åˆ° Daemon
- âŒ éœ€è¦åˆ›å»ºç»Ÿä¸€çš„ REST API
- âŒ éœ€è¦è·¯ç”±å™¨æ•´åˆæ‰€æœ‰ç«¯ç‚¹
- âŒ éœ€è¦ç»Ÿä¸€çš„å‰ç«¯å…¥å£

### 3. ç«¯åˆ°ç«¯æµ‹è¯•
- âŒ æ²¡æœ‰ CLI é›†æˆæµ‹è¯•
- âŒ æ²¡æœ‰ Web UI é›†æˆæµ‹è¯•
- âŒ æ²¡æœ‰ç§»åŠ¨ç«¯é›†æˆæµ‹è¯•
- âŒ æ²¡æœ‰å®Œæ•´æµç¨‹æµ‹è¯•

### 4. ç»Ÿä¸€ API ç½‘å…³
- âŒ å¤šä¸ªç«¯å£ï¼ˆ9529, 9875, 9876, 9877, 3000ï¼‰
- âŒ å¤šç§åè®®ï¼ˆIPC, HTTP, WebSocketï¼‰
- âŒ ä¸ä¸€è‡´çš„æ•°æ®æ ¼å¼
- âŒ ç¼ºå°‘ API æ–‡æ¡£

---

## ğŸ¯ çœŸå®äº¤ä»˜è¯„ä¼°

### å½“å‰å¯äº¤ä»˜å†…å®¹ (15%)

**ä»…é™:**
1. âœ… **æ’ä»¶å¸‚åœº UI** (http://localhost:9877)
   - å¯ä»¥æµè§ˆã€å®‰è£…ã€é…ç½®æ’ä»¶
   - å¯ä»¥å¯åŠ¨/åœæ­¢æ’ä»¶
   - å¯ä»¥æ£€æŸ¥æ›´æ–°

2. âœ… **Daemon æ ¸å¿ƒ** (åå°è¿è¡Œ)
   - IPC æœåŠ¡å™¨
   - WebSocket æœåŠ¡å™¨
   - çŠ¶æ€ API
   - æ’ä»¶ç®¡ç†å™¨

**ä½†æ˜¯:**
- âŒ æ²¡æœ‰å¯ç”¨çš„ CLI
- âŒ æ²¡æœ‰å¯ç”¨çš„ Web Dashboard
- âŒ ç§»åŠ¨ç«¯æœªéªŒè¯
- âŒ æ— æ³•è¿›è¡Œå®Œæ•´çš„ä»»åŠ¡æµç¨‹

---

### éœ€è¦å®Œæˆæ‰èƒ½çœŸæ­£äº¤ä»˜ (85%)

#### ä¼˜å…ˆçº§1 (å¿…é¡») - 2å‘¨

1. **ä¿®å¤ Web UI é›†æˆ**
   - åˆ›å»ºç»Ÿä¸€çš„ REST API (/api/v1/*)
   - æ•´åˆæ‰€æœ‰ç«¯ç‚¹åˆ°ä¸€ä¸ªè·¯ç”±å™¨
   - ä¿®å¤ç«¯å£å’Œè·¯å¾„ä¸åŒ¹é…

2. **æ„å»º CLI å·¥å…·**
   - ç¼–è¯‘ Rust CLI
   - åˆ›å»ºå®‰è£…è„šæœ¬
   - éªŒè¯ IPC é€šä¿¡

3. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - CLI æäº¤ä»»åŠ¡
   - Web UI æŸ¥çœ‹çŠ¶æ€
   - æ’ä»¶æ‰§è¡Œå·¥å…·

#### ä¼˜å…ˆçº§2 (é‡è¦) - 1å‘¨

4. **ç»Ÿä¸€å…¥å£**
   - åå‘ä»£ç†é…ç½®
   - å•ä¸€ç«¯å£è®¿é—®
   - è·¯ç”±æ•´åˆ

5. **ç§»åŠ¨ç«¯éªŒè¯**
   - å®é™…è®¾å¤‡æµ‹è¯•
   - é…å¯¹æµç¨‹æµ‹è¯•
   - WebSocket é€šä¿¡æµ‹è¯•

#### ä¼˜å…ˆçº§3 (å¢å¼º) - 1å‘¨

6. **æ–‡æ¡£å’Œç¤ºä¾‹**
   - API æ–‡æ¡£
   - é›†æˆç¤ºä¾‹
   - æ•…éšœæ’æŸ¥æŒ‡å—

---

## ğŸ’¡ ä¿®å¤å»ºè®®

### ç«‹å³è¡ŒåŠ¨ (æœ¬å‘¨)

1. **åˆ›å»ºç»Ÿä¸€ API è·¯ç”±å™¨**
```dart
// daemon/lib/api/api_router.dart
class UnifiedApiRouter {
  router.post('/api/v1/execute', _handleExecute);
  router.post('/api/v1/tasks', _handleTaskSubmit);
  router.get('/api/v1/tasks', _handleTaskList);
  router.get('/api/v1/status', _handleStatus);
  // æ•´åˆæ‰€æœ‰ç«¯ç‚¹
}
```

2. **ä¿®å¤ Web UI é…ç½®**
```typescript
// web-ui/src/api/client.ts
const API_BASE = 'http://localhost:9875/api/v1';
// æ”¹ä¸ºåŒ¹é…å®é™…ç«¯ç‚¹
```

3. **ç¼–è¯‘ CLI**
```bash
cd cli
cargo build --release
# åˆ›å»ºå®‰è£…è„šæœ¬
```

### çŸ­æœŸç›®æ ‡ (2å‘¨å†…)

1. æ‰€æœ‰å®¢æˆ·ç«¯èƒ½è¿æ¥åˆ° Daemon
2. å®Œæ•´çš„ä»»åŠ¡æäº¤ â†’ æ‰§è¡Œ â†’ æŸ¥çœ‹æµç¨‹
3. åŸºæœ¬çš„é›†æˆæµ‹è¯•é€šè¿‡

### ä¸­æœŸç›®æ ‡ (4å‘¨å†…)

1. ç»Ÿä¸€çš„ API ç½‘å…³
2. å®Œæ•´çš„æ–‡æ¡£
3. å‘å¸ƒå°±ç»ªçš„å®‰è£…åŒ…

---

## ğŸ“ ç»“è®º

**ä¹‹å‰çš„è¯„ä¼°è¿‡äºä¹è§‚ã€‚å®é™…æƒ…å†µæ˜¯:**

1. âœ… **Daemon æ ¸å¿ƒ** - æ¶æ„è‰¯å¥½ï¼ŒåŠŸèƒ½å®Œæ•´
2. âœ… **æ’ä»¶ç³»ç»Ÿ** - å®Œå…¨å¯ç”¨
3. âŒ **å®¢æˆ·ç«¯é›†æˆ** - ä¸¥é‡ä¸è¶³
4. âŒ **ç«¯åˆ°ç«¯æµç¨‹** - æ— æ³•éªŒè¯

**çœŸå®å¯äº¤ä»˜æ€§:**

| åœºæ™¯ | ä¹‹å‰è¯„ä¼° | å®é™…æƒ…å†µ | å·®è· |
|------|---------|---------|------|
| Alpha æµ‹è¯• | âœ… ç«‹å³ | âš ï¸ 2å‘¨å | éœ€è¦ä¿®å¤é›†æˆ |
| ç”Ÿäº§è¯•ç‚¹ | âš ï¸ 2-3å‘¨ | âš ï¸ 4-6å‘¨ | éœ€è¦å®Œæ•´æµ‹è¯• |
| ä¼ä¸šéƒ¨ç½² | âš ï¸ 4-6å‘¨ | âš ï¸ 8-10å‘¨ | éœ€è¦å…¨é¢å®Œå–„ |

**æ¨èå†³ç­–:**
- âŒ **ä¸å»ºè®®ç«‹å³äº¤ä»˜** - å®¢æˆ·ç«¯æ— æ³•ä½¿ç”¨
- âš ï¸ **2å‘¨åå¯äº¤ä»˜ Alpha** - ä¿®å¤æ ¸å¿ƒé›†æˆå
- âš ï¸ **4-6å‘¨åå¯äº¤ä»˜ç”Ÿäº§è¯•ç‚¹** - å®Œæ•´æµ‹è¯•å

---

**è¯„ä¼°äºº:** æŠ€æœ¯æ·±åº¦å®¡æŸ¥
**æ—¥æœŸ:** 2025-02-05
**ä¸¥é‡ç¨‹åº¦:** ğŸ”´ é«˜ - å½±å“å®é™…å¯ç”¨æ€§
